<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞–º–∏</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .category-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--clr-primary);
        }

        .category-card.restricted {
            border-left-color: var(--clr-danger);
        }

        .access-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }

        .badge-public {
            background: var(--clr-success);
            color: white;
        }

        .badge-restricted {
            background: var(--clr-danger);
            color: white;
        }

        .badge-student-create {
            background: var(--clr-warning);
            color: white;
        }

        .group-tag {
            display: inline-block;
            background: var(--clr-bg);
            color: var(--clr-text-dark);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            margin: 0.25rem;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h2><a href="/" style="color: white; text-decoration: none;">–§–æ—Ä—É–º</a></h2>
        <div class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞–º–∏</div>
    </div>

    <ul class="sidebar-nav">
        <li><a th:href="@{/hello}"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</a></li>
        <li><a th:href="@{/posts}"><i class="fas fa-comments"></i> –ü–æ—Å—Ç—ã</a></li>
        <li sec:authorize="hasRole('ADMIN')">
            <a th:href="@{/admin/dashboard}"><i class="fas fa-tachometer-alt"></i> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a>
        </li>
        <li sec:authorize="hasRole('ADMIN')">
            <a th:href="@{/admin/groups}"><i class="fas fa-users"></i> –ì—Ä—É–ø–ø—ã</a>
        </li>
        <li sec:authorize="hasRole('ADMIN')">
            <a th:href="@{/admin/categories}" class="active"><i class="fas fa-folder"></i> –†–∞–∑–¥–µ–ª—ã</a>
        </li>
    </ul>

    <div class="user-info" sec:authorize="isAuthenticated()">
        <div style="font-weight: 600; margin-bottom: 0.25rem;">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫:</div>
        <div style="font-size: 0.875rem;" sec:authentication="name"></div>
    </div>

    <form th:action="@{/logout}" method="post" sec:authorize="isAuthenticated()">
        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
        <button type="submit" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
        </button>
    </form>
</div>

<div class="main">
    <div class="page-header">
        <h1><i class="fas fa-folder"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞–º–∏</h1>
        <div class="subtitle">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–∞–∑–¥–µ–ª—ã —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞</div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div th:if="${success}" class="alert alert-success">
        <i class="fas fa-check-circle"></i> <span th:text="${success}"></span>
    </div>

    <div th:if="${error}" class="alert alert-error">
        <i class="fas fa-exclamation-triangle"></i> <span th:text="${error}"></span>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid" style="margin-bottom: 2rem;">
        <div class="stat-card">
            <div class="stat-icon">üìÅ</div>
            <div class="stat-number" th:text="${totalCategories}">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ —Ä–∞–∑–¥–µ–ª–æ–≤</div>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞ -->
    <div class="card">
        <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª</h2>

        <form th:action="@{/admin/categories/create}" method="post">
            <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />

            <div class="form-group">
                <label for="categoryName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ *</label>
                <input type="text" id="categoryName" name="name" class="form-input"
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞" required maxlength="100">
            </div>

            <div class="form-group">
                <label for="categoryDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="categoryDescription" name="description" class="form-input"
                          placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞, —Ç–µ–º—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è"
                          rows="3" maxlength="1000"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞</label>

                <div style="display: flex; gap: 2rem; margin-top: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="visibleToAll" value="true" checked>
                        <span>–í–∏–¥–µ–Ω –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</span>
                    </label>

                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="studentsCanCreatePosts" value="true" checked>
                        <span>–°—Ç—É–¥–µ–Ω—Ç—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Å—Ç—ã</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label for="categoryTeacher" class="form-label">–ö—É—Ä–∞—Ç–æ—Ä (–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å)</label>
                <select id="categoryTeacher" name="teacherId" class="form-input">
                    <option value="">–ë–µ–∑ –∫—É—Ä–∞—Ç–æ—Ä–∞</option>
                    <option th:each="teacher : ${teachers}"
                            th:value="${teacher.id}"
                            th:text="${teacher.fullName != null ? teacher.fullName : teacher.username}">
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã (–µ—Å–ª–∏ —Ä–∞–∑–¥–µ–ª –Ω–µ –¥–ª—è –≤—Å–µ—Ö)</label>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                    <label th:each="group : ${allGroups}"
                           style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                        <input type="checkbox" name="allowedGroupIds" th:value="${group.id}">
                        <span class="group-tag" th:text="${group.name}"></span>
                    </label>
                </div>
                <div class="form-hint">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã, –∫–æ—Ç–æ—Ä—ã–º –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ä–∞–∑–¥–µ–ª</div>
            </div>

            <div class="form-actions">
                <button type="submit" class="submit-btn">
                    <i class="fas fa-save"></i> –°–æ–∑–¥–∞—Ç—å —Ä–∞–∑–¥–µ–ª
                </button>
            </div>
        </form>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ -->
    <div class="card">
        <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-list"></i> –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–∞–∑–¥–µ–ª—ã</h2>

        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
        <div th:if="${categories == null or categories.isEmpty()}" class="empty-state">
            <i class="fas fa-folder-open"></i>
            <h3>–†–∞–∑–¥–µ–ª—ã –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</h3>
            <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ä–∞–∑–¥–µ–ª, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ</p>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Ä–∞–∑–¥–µ–ª–æ–≤ -->
        <div th:if="${categories != null and not categories.isEmpty()}">
            <div th:each="category : ${categories}" th:id="'category-' + ${category.id}"
                 th:classappend="${category.visibleToAll ? 'category-card' : 'category-card restricted'}"
                 class="category-card">

                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div>
                        <h3 style="margin: 0; color: var(--clr-text-dark);" th:text="${category.name}">
                            –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
                        </h3>

                        <div style="color: var(--clr-text-light); margin-top: 0.5rem;"
                             th:text="${category.description} ?: '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'">
                        </div>

                        <div style="margin-top: 0.5rem;">
              <span class="access-badge"
                    th:classappend="${category.visibleToAll ? 'badge-public' : 'badge-restricted'}"
                    th:text="${category.visibleToAll ? '–û—Ç–∫—Ä—ã—Ç—ã–π' : '–ó–∞–∫—Ä—ã—Ç—ã–π'}">
              </span>

                            <span class="access-badge badge-student-create"
                                  th:if="${category.studentsCanCreatePosts}">
                –°—Ç—É–¥–µ–Ω—Ç—ã –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å
              </span>

                            <span th:if="${category.teacher != null}" style="font-size: 0.875rem; margin-left: 0.5rem;">
                <i class="fas fa-chalkboard-teacher"></i> 
                <span th:text="${category.teacher.fullName != null ? category.teacher.fullName : category.teacher.username}"></span>
              </span>
                        </div>

                        <!-- –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã -->
                        <div th:if="${not category.visibleToAll and not category.allowedGroups.isEmpty()}"
                             style="margin-top: 0.5rem;">
                            <div style="font-size: 0.875rem; color: var(--clr-text-light); margin-bottom: 0.25rem;">
                                <i class="fas fa-user-graduate"></i> –î–æ—Å—Ç—É–ø–Ω—ã–µ –≥—Ä—É–ø–ø—ã:
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                <span th:each="group : ${category.allowedGroups}"
                      class="group-tag" th:text="${group.name}">
                </span>
                            </div>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button type="button" class="action-btn" th:onclick="'showEditForm(' + ${category.id} + ')'">
                            <i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å
                        </button>
                        <form th:action="@{/admin/categories/{id}/delete(id=${category.id})}" method="post"
                              onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª? –í—Å–µ –ø–æ—Å—Ç—ã –≤ —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –æ–±—â–∏–π —Ä–∞–∑–¥–µ–ª.');">
                            <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
                            <button type="submit" class="action-btn delete-btn">
                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </form>
                    </div>
                </div>

                <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞ -->
                <div th:id="'edit-form-' + ${category.id}" style="display: none; background: var(--clr-bg); padding: 1.5rem; border-radius: var(--radius); margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–¥–µ–ª</h4>
                    <form th:action="@{/admin/categories/{id}/update(id=${category.id})}" method="post">
                        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                <input type="text" name="name" th:value="${category.name}" class="form-input" required>
                            </div>
                            <div>
                                <label class="form-label">–ö—É—Ä–∞—Ç–æ—Ä</label>
                                <select name="teacherId" class="form-input">
                                    <option value="">–ë–µ–∑ –∫—É—Ä–∞—Ç–æ—Ä–∞</option>
                                    <option th:each="teacher : ${teachers}"
                                            th:value="${teacher.id}"
                                            th:selected="${category.teacher != null and category.teacher.id == teacher.id}"
                                            th:text="${teacher.fullName != null ? teacher.fullName : teacher.username}">
                                    </option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea name="description" class="form-input" rows="2"
                                      th:text="${category.description}"></textarea>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" name="visibleToAll" th:checked="${category.visibleToAll}">
                                <span>–í–∏–¥–µ–Ω –≤—Å–µ–º</span>
                            </label>

                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" name="studentsCanCreatePosts" th:checked="${category.studentsCanCreatePosts}">
                                <span>–°—Ç—É–¥–µ–Ω—Ç—ã –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å</span>
                            </label>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label class="form-label">–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                <label th:each="group : ${allGroups}"
                                       style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                    <input type="checkbox" name="allowedGroupIds" th:value="${group.id}"
                                           th:checked="${category.allowedGroups.contains(group)}">
                                    <span class="group-tag" th:text="${group.name}"></span>
                                </label>
                            </div>
                        </div>

                        <div style="display: flex; gap: 0.5rem;">
                            <button type="submit" class="submit-btn">
                                <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                            <button type="button" class="action-btn" th:onclick="'hideEditForm(' + ${category.id} + ')'">
                                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function showEditForm(categoryId) {
        const form = document.getElementById('edit-form-' + categoryId);
        if (form) {
            form.style.display = 'block';
            form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    function hideEditForm(categoryId) {
        const form = document.getElementById('edit-form-' + categoryId);
        if (form) {
            form.style.display = 'none';
        }
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    setTimeout(() => {
        document.querySelectorAll('.alert').forEach(alert => {
            alert.style.opacity = '0';
            alert.style.transition = 'opacity 0.5s';
            setTimeout(() => alert.remove(), 500);
        });
    }, 5000);
</script>
</body>
</html>